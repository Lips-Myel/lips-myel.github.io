(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const o of t.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function n(e){if(e.ep)return;e.ep=!0;const t=r(e);fetch(e.href,t)}})();let c,m,d,p;const f=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function E(a){const s=new TextEncoder,r=await crypto.subtle.importKey("raw",s.encode(a),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:f,iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function T(a,s){const r=await E(s),n=a.slice(0,12),e=a.slice(12);return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:n},r,e))}async function g(a,s){const r=await E(s),n=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},r,a),t=new Uint8Array(n.length+e.byteLength);return t.set(n),t.set(new Uint8Array(e),12),t}async function w(){const a=document.getElementById("master-pass").value.trim();if(!a)return alert("Master Password requis");const s=await initSqlJs({locateFile:r=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${r}`});try{const r=await fetch("db.encrypted");if(r.ok){const n=await r.arrayBuffer(),e=await T(new Uint8Array(n),a);c=new s.Database(e)}else c=new s.Database}catch{c=new s.Database}m=a,b(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",p=new Quill("#task-editor",{theme:"snow"}),S()}function b(){c.exec("CREATE TABLE IF NOT EXISTS users(id INTEGER PRIMARY KEY,username TEXT UNIQUE,password TEXT,salt TEXT);CREATE TABLE IF NOT EXISTS tasks(id INTEGER PRIMARY KEY,user_id INTEGER,title TEXT,description TEXT,completed INTEGER DEFAULT 0,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(user_id)REFERENCES users(id));");try{c.exec("ALTER TABLE users ADD COLUMN salt TEXT")}catch{}}async function I(){if(!c||!m)return;const a=c.export(),s=await g(a,m),r=new Blob([s]),n=URL.createObjectURL(r),e=document.createElement("a");e.href=n,e.download="db.encrypted",e.click(),URL.revokeObjectURL(n),Swal.fire({toast:!0,icon:"success",title:"db.encrypted tÃ©lÃ©chargÃ© ! Remplace-le sur le serveur",timer:3e3})}async function u(a,s){const r=new TextEncoder,n=await crypto.subtle.importKey("raw",r.encode(a),"PBKDF2",!1,["deriveBits"]),e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:s,iterations:1e5,hash:"SHA-256"},n,256);return Array.from(new Uint8Array(e)).map(t=>t.toString(16).padStart(2,"0")).join("")}function S(){if(c.prepare("SELECT COUNT(*) as c FROM users").get().c===0){const n=crypto.getRandomValues(new Uint8Array(16));u("demo123",n).then(e=>{const t=Array.from(n).map(o=>o.toString(16).padStart(2,"0")).join("");c.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run("demo",e,t),d=c.prepare("SELECT id FROM users WHERE username=?").get("demo").id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",r(),Swal.fire({toast:!0,icon:"success",title:"Compte dÃ©mo crÃ©Ã© ! (demo / demo123)",timer:4e3})})}const s=document.createElement("button");s.className="btn",s.style.background="#007bff",s.style.marginLeft="10px",s.innerHTML="ðŸ“¥ Sauvegarder db.encrypted",s.onclick=I,document.querySelector(".header-tasks").appendChild(s),document.getElementById("register-form").addEventListener("submit",async n=>{n.preventDefault();const e=document.getElementById("register-username").value.trim(),t=document.getElementById("register-password").value,o=crypto.getRandomValues(new Uint8Array(16)),i=await u(t,o),l=Array.from(o).map(y=>y.toString(16).padStart(2,"0")).join("");try{c.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run(e,i,l),Swal.fire({toast:!0,icon:"success",title:"Compte crÃ©Ã©"}),n.target.reset()}catch{Swal.fire({toast:!0,icon:"error",title:"Username dÃ©jÃ  pris"})}}),document.getElementById("login-form").addEventListener("submit",async n=>{n.preventDefault();const e=document.getElementById("login-username").value.trim(),t=document.getElementById("login-password").value,o=c.prepare("SELECT id,password,salt FROM users WHERE username=?").get(e);if(o){const i=new Uint8Array(o.salt.match(/.{1,2}/g).map(l=>parseInt(l,16)));if(await u(t,i)===o.password){d=o.id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",r();return}}Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects"})}),document.getElementById("add-task-form").addEventListener("submit",n=>{if(n.preventDefault(),!d)return;const e=document.getElementById("task-title").value.trim(),t=p.root.innerHTML;c.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run(d,e,t),document.getElementById("task-title").value="",p.setContents([]),r()});function r(){const n=c.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC").all(d),e=document.getElementById("tasks-list");e.innerHTML="",n.forEach(t=>{const o=document.createElement("li");o.className=t.completed?"completed":"",o.innerHTML=`<div class="task-header"><h3>${t.title}</h3><div class="btn-container"><button class="btn-delete" data-id="${t.id}">Supprimer</button>${t.completed===0?`<button class="btn-complete" data-id="${t.id}">Terminer</button>`:""}</div></div><div class="task-content">${t.description}</div>`,o.querySelector(".btn-delete").onclick=()=>{c.exec(`DELETE FROM tasks WHERE id=${t.id}`),r()};const i=o.querySelector(".btn-complete");i&&(i.onclick=()=>{c.exec(`UPDATE tasks SET completed=1 WHERE id=${t.id}`),r()}),e.appendChild(o)})}document.getElementById("logout").onclick=()=>{d=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none",document.getElementById("tasks-list").innerHTML=""}}globalThis.unlockDB=w;
