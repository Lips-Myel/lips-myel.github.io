(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function r(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function n(e){if(e.ep)return;e.ep=!0;const t=r(e);fetch(e.href,t)}})();let c,m,d,p;const u="demo2026",w=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function y(o){const s=new TextEncoder,r=await crypto.subtle.importKey("raw",s.encode(o),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:w,iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function S(o,s){const r=await y(s),n=o.slice(0,12),e=o.slice(12);return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:n},r,e))}async function I(o,s){const r=await y(s),n=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},r,o),t=new Uint8Array(n.length+e.byteLength);return t.set(n),t.set(new Uint8Array(e),12),t}async function b(){if(document.getElementById("master-pass").value.trim()!==u)return alert("Master Password incorrect â†’ dÃ©mo : demo2026");const s=await initSqlJs({locateFile:r=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${r}`});try{const r=await fetch("db.encrypted",{cache:"no-store"});if(r.ok){const n=await r.arrayBuffer(),e=await S(new Uint8Array(n),u);c=new s.Database(e)}else c=new s.Database}catch{c=new s.Database}m=u,f(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",p=new Quill("#task-editor",{theme:"snow"}),R()}function f(){c.exec(`
    CREATE TABLE IF NOT EXISTS users(id INTEGER PRIMARY KEY,username TEXT UNIQUE,password TEXT,salt TEXT);
    CREATE TABLE IF NOT EXISTS tasks(id INTEGER PRIMARY KEY,user_id INTEGER,title TEXT,description TEXT,completed INTEGER DEFAULT 0,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(user_id)REFERENCES users(id));
  `)}async function T(){if(!c||!m)return;const o=c.export(),s=await I(o,m),r=new Blob([s]),n=URL.createObjectURL(r),e=document.createElement("a");e.href=n,e.download="db.encrypted",e.click(),URL.revokeObjectURL(n),Swal.fire({toast:!0,icon:"success",title:"âœ… db.encrypted sauvegardÃ© !",timer:3e3})}async function E(o,s){const r=new TextEncoder,n=await crypto.subtle.importKey("raw",r.encode(o),"PBKDF2",!1,["deriveBits"]),e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:s,iterations:1e5,hash:"SHA-256"},n,256);return Array.from(new Uint8Array(e)).map(t=>t.toString(16).padStart(2,"0")).join("")}async function h(){c.exec("DELETE FROM users"),c.exec("DELETE FROM tasks"),f();const o=crypto.getRandomValues(new Uint8Array(16)),s=await E("demo123",o),r=Array.from(o).map(n=>n.toString(16).padStart(2,"0")).join("");c.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run("demo",s,r),d=c.prepare("SELECT id FROM users WHERE username=?").get("demo").id,loadTasks(),T(),Swal.fire({toast:!0,icon:"success",title:"Reset complet effectuÃ©",timer:4e3})}setInterval(()=>{confirm(`ðŸ”„ Reset auto de la dÃ©mo (toutes les 30 minutes) ?
TOUS les comptes ET toutes les tÃ¢ches seront supprimÃ©s.`)&&h()},1800*1e3);function R(){const o=document.querySelector(".header-tasks"),s=document.createElement("button");s.className="btn",s.style.background="#007bff",s.style.marginLeft="10px",s.innerHTML="ðŸ“¥ Sauvegarder db.encrypted",s.onclick=T,o.appendChild(s),document.getElementById("register-form").addEventListener("submit",async function(n){n.preventDefault(),n.stopImmediatePropagation();const e=document.getElementById("register-username").value.trim(),t=document.getElementById("register-password").value;if(!e||!t)return Swal.fire({toast:!0,icon:"error",title:"Champs requis"});const a=crypto.getRandomValues(new Uint8Array(16)),i=await E(t,a),l=Array.from(a).map(g=>g.toString(16).padStart(2,"0")).join("");try{c.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run(e,i,l),Swal.fire({toast:!0,icon:"success",title:"Compte crÃ©Ã© avec succÃ¨s"}),n.target.reset()}catch{Swal.fire({toast:!0,icon:"error",title:"Username dÃ©jÃ  pris"})}}),document.getElementById("login-form").addEventListener("submit",async function(n){n.preventDefault(),n.stopImmediatePropagation();const e=document.getElementById("login-username").value.trim(),t=document.getElementById("login-password").value,a=c.prepare("SELECT id,password,salt FROM users WHERE username=?").get(e);if(a){const i=new Uint8Array(a.salt.match(/.{1,2}/g).map(l=>parseInt(l,16)));if(await E(t,i)===a.password){d=a.id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",r();return}}Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects"})}),document.getElementById("add-task-form").addEventListener("submit",function(n){if(n.preventDefault(),!d)return;const e=document.getElementById("task-title").value.trim(),t=p.root.innerHTML;c.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run(d,e,t),document.getElementById("task-title").value="",p.setContents([]),r()});function r(){const n=c.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC").all(d),e=document.getElementById("tasks-list");e.innerHTML="",n.forEach(t=>{const a=document.createElement("li");a.className=t.completed?"completed":"",a.innerHTML=`<div class="task-header"><h3>${t.title}</h3><div class="btn-container"><button class="btn-delete" data-id="${t.id}">Supprimer</button>${t.completed===0?`<button class="btn-complete" data-id="${t.id}">Terminer</button>`:""}</div></div><div class="task-content">${t.description}</div>`,a.querySelector(".btn-delete").onclick=()=>{c.exec(`DELETE FROM tasks WHERE id=${t.id}`),r()};const i=a.querySelector(".btn-complete");i&&(i.onclick=()=>{c.exec(`UPDATE tasks SET completed=1 WHERE id=${t.id}`),r()}),e.appendChild(a)})}document.getElementById("logout").onclick=()=>{d=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none"}}globalThis.unlockDB=b;
