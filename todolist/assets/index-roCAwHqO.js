(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(e){if(e.ep)return;e.ep=!0;const r=t(e);fetch(e.href,r)}})();let a,m,i,p;const u="demo2026",S=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function y(o){const n=new TextEncoder,t=await crypto.subtle.importKey("raw",n.encode(o),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:S,iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function b(o,n){const t=await y(n),s=o.slice(0,12),e=o.slice(12);return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:s},t,e))}async function h(o,n){const t=await y(n),s=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},t,o),r=new Uint8Array(s.length+e.byteLength);return r.set(s),r.set(new Uint8Array(e),12),r}async function I(){if(document.getElementById("master-pass").value.trim()!==u)return alert("Master Password incorrect â†’ dÃ©mo : demo2026");const n=await initSqlJs({locateFile:t=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${t}`});try{const t=await fetch("db.encrypted",{cache:"no-store"});if(t.ok){const s=await t.arrayBuffer(),e=await b(new Uint8Array(s),u);a=new n.Database(e)}else a=new n.Database}catch{a=new n.Database}m=u,f(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",p=new Quill("#task-editor",{theme:"snow"}),R()}function f(){a.exec(`
    CREATE TABLE IF NOT EXISTS users(id INTEGER PRIMARY KEY,username TEXT UNIQUE,password TEXT,salt TEXT);
    CREATE TABLE IF NOT EXISTS tasks(id INTEGER PRIMARY KEY,user_id INTEGER,title TEXT,description TEXT,completed INTEGER DEFAULT 0,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(user_id)REFERENCES users(id));
  `);try{a.exec("ALTER TABLE users ADD COLUMN salt TEXT")}catch{}}async function T(){if(!a||!m)return;const o=a.export(),n=await h(o,m),t=new Blob([n]),s=URL.createObjectURL(t),e=document.createElement("a");e.href=s,e.download="db.encrypted",e.click(),URL.revokeObjectURL(s),Swal.fire({toast:!0,icon:"success",title:"âœ… db.encrypted sauvegardÃ© !",timer:3e3})}async function E(o,n){const t=new TextEncoder,s=await crypto.subtle.importKey("raw",t.encode(o),"PBKDF2",!1,["deriveBits"]),e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},s,256);return Array.from(new Uint8Array(e)).map(r=>r.toString(16).padStart(2,"0")).join("")}async function w(){a.exec("DELETE FROM users"),a.exec("DELETE FROM tasks"),f();const o=crypto.getRandomValues(new Uint8Array(16)),n=await E("demo123",o),t=Array.from(o).map(s=>s.toString(16).padStart(2,"0")).join("");a.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run("demo",n,t),i=a.prepare("SELECT id FROM users WHERE username=?").get("demo").id,d(),T(),Swal.fire({toast:!0,icon:"success",title:"Reset complet effectuÃ©",timer:4e3})}setInterval(()=>{confirm(`ðŸ”„ Reset auto de la dÃ©mo (toutes les 30 minutes) ?
TOUS les comptes ET toutes les tÃ¢ches seront supprimÃ©s.`)&&w()},1800*1e3);function d(){const o=a.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC").all(i),n=document.getElementById("tasks-list");n.innerHTML="",o.forEach(t=>{const s=document.createElement("li");s.className=t.completed?"completed":"",s.innerHTML=`<div class="task-header"><h3>${t.title}</h3><div class="btn-container"><button class="btn-delete" data-id="${t.id}">Supprimer</button>${t.completed===0?`<button class="btn-complete" data-id="${t.id}">Terminer</button>`:""}</div></div><div class="task-content">${t.description}</div>`,s.querySelector(".btn-delete").onclick=()=>{a.exec(`DELETE FROM tasks WHERE id=${t.id}`),d()};const e=s.querySelector(".btn-complete");e&&(e.onclick=()=>{a.exec(`UPDATE tasks SET completed=1 WHERE id=${t.id}`),d()}),n.appendChild(s)})}function R(){const o=document.querySelector(".header-tasks"),n=document.createElement("button");n.className="btn",n.style.background="#007bff",n.style.marginLeft="10px",n.innerHTML="ðŸ“¥ Sauvegarder db.encrypted",n.onclick=T,o.appendChild(n),document.getElementById("register-form").addEventListener("submit",async t=>{t.preventDefault();const s=document.getElementById("register-username").value.trim(),e=document.getElementById("register-password").value,r=crypto.getRandomValues(new Uint8Array(16)),c=await E(e,r),l=Array.from(r).map(g=>g.toString(16).padStart(2,"0")).join("");try{a.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run(s,c,l),Swal.fire({toast:!0,icon:"success",title:"Compte crÃ©Ã©"}),t.target.reset()}catch{Swal.fire({toast:!0,icon:"error",title:"Username dÃ©jÃ  pris"})}}),document.getElementById("login-form").addEventListener("submit",async t=>{t.preventDefault();const s=document.getElementById("login-username").value.trim(),e=document.getElementById("login-password").value,r=a.prepare("SELECT id,password,salt FROM users WHERE username=?").get(s);if(r){if(!r.salt){Swal.fire({toast:!0,icon:"info",title:"Base ancienne â†’ reset auto"}),w();return}const c=new Uint8Array(r.salt.match(/.{1,2}/g).map(l=>parseInt(l,16)));if(await E(e,c)===r.password){i=r.id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",d();return}}Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects"})}),document.getElementById("add-task-form").addEventListener("submit",t=>{if(t.preventDefault(),!i)return;const s=document.getElementById("task-title").value.trim(),e=p.root.innerHTML;a.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run(i,s,e),document.getElementById("task-title").value="",p.setContents([]),d()}),document.getElementById("logout").onclick=()=>{i=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none"}}globalThis.unlockDB=I;
