(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const c of t.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function r(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(e){if(e.ep)return;e.ep=!0;const t=r(e);fetch(e.href,t)}})();let a,p,d,E;const m="demo2026",f="6LcWbHksAAAAAJBRAGRIgOSLYoYdxFFpAnJDI_O2",S=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function T(o){const n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(o),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:S,iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function I(o,n){const r=await T(n),s=o.slice(0,12),e=o.slice(12);return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:s},r,e))}async function b(o,n){const r=await T(n),s=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},r,o),t=new Uint8Array(s.length+e.byteLength);return t.set(s),t.set(new Uint8Array(e),12),t}async function h(){if(document.getElementById("master-pass").value.trim()!==m)return alert("Master Password incorrect â†’ dÃ©mo : demo2026");const n=await initSqlJs({locateFile:r=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${r}`});try{const r=await fetch("db.encrypted",{cache:"no-store"});if(r.ok){const s=await r.arrayBuffer(),e=await I(new Uint8Array(s),m);a=new n.Database(e)}else a=new n.Database}catch{a=new n.Database}p=m,g(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",E=new Quill("#task-editor",{theme:"snow"}),v()}function g(){a.exec(`
    CREATE TABLE IF NOT EXISTS users(id INTEGER PRIMARY KEY,username TEXT UNIQUE,password TEXT,salt TEXT);
    CREATE TABLE IF NOT EXISTS tasks(id INTEGER PRIMARY KEY,user_id INTEGER,title TEXT,description TEXT,completed INTEGER DEFAULT 0,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(user_id)REFERENCES users(id));
  `)}setInterval(()=>{confirm(`ðŸ”„ Reset auto de la dÃ©mo (toutes les 30 minutes) ?
TOUS les comptes ET toutes les tÃ¢ches seront supprimÃ©s.`)&&R()},1800*1e3);async function R(){a.exec("DELETE FROM users"),a.exec("DELETE FROM tasks"),g();const o=crypto.getRandomValues(new Uint8Array(16)),n=await y("demo123",o),r=Array.from(o).map(s=>s.toString(16).padStart(2,"0")).join("");a.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run("demo",n,r),d=a.prepare("SELECT id FROM users WHERE username=?").get("demo").id,loadTasks(),w(),Swal.fire({toast:!0,icon:"success",title:"Reset complet : tous les users + tÃ¢ches supprimÃ©s",timer:4e3})}async function w(){if(!a||!p)return;const o=a.export(),n=await b(o,p),r=new Blob([n]),s=URL.createObjectURL(r),e=document.createElement("a");e.href=s,e.download="db.encrypted",e.click(),URL.revokeObjectURL(s),Swal.fire({toast:!0,icon:"success",title:"âœ… db.encrypted sauvegardÃ© !",timer:3e3})}async function y(o,n){const r=new TextEncoder,s=await crypto.subtle.importKey("raw",r.encode(o),"PBKDF2",!1,["deriveBits"]),e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},s,256);return Array.from(new Uint8Array(e)).map(t=>t.toString(16).padStart(2,"0")).join("")}function v(){const o=document.querySelector(".header-tasks"),n=document.createElement("button");n.className="btn",n.style.background="#007bff",n.style.marginLeft="10px",n.innerHTML="ðŸ“¥ Sauvegarder db.encrypted",n.onclick=w,o.appendChild(n),document.getElementById("register-form").addEventListener("submit",async s=>{s.preventDefault();const e=await grecaptcha.execute(f,{action:"register"});console.log("âœ… reCAPTCHA v3 (register) token:",e);const t=document.getElementById("register-username").value.trim(),c=document.getElementById("register-password").value,i=crypto.getRandomValues(new Uint8Array(16)),l=await y(c,i),u=Array.from(i).map(A=>A.toString(16).padStart(2,"0")).join("");try{a.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run(t,l,u),Swal.fire({toast:!0,icon:"success",title:"Compte crÃ©Ã©"}),s.target.reset()}catch{Swal.fire({toast:!0,icon:"error",title:"Username dÃ©jÃ  pris"})}}),document.getElementById("login-form").addEventListener("submit",async s=>{s.preventDefault();const e=await grecaptcha.execute(f,{action:"login"});console.log("âœ… reCAPTCHA v3 (login) token:",e);const t=document.getElementById("login-username").value.trim(),c=document.getElementById("login-password").value,i=a.prepare("SELECT id,password,salt FROM users WHERE username=?").get(t);if(i){const l=new Uint8Array(i.salt.match(/.{1,2}/g).map(u=>parseInt(u,16)));if(await y(c,l)===i.password){d=i.id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",r();return}}Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects"})}),document.getElementById("add-task-form").addEventListener("submit",s=>{if(s.preventDefault(),!d)return;const e=document.getElementById("task-title").value.trim(),t=E.root.innerHTML;a.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run(d,e,t),document.getElementById("task-title").value="",E.setContents([]),r()});function r(){const s=a.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC").all(d),e=document.getElementById("tasks-list");e.innerHTML="",s.forEach(t=>{const c=document.createElement("li");c.className=t.completed?"completed":"",c.innerHTML=`<div class="task-header"><h3>${t.title}</h3><div class="btn-container"><button class="btn-delete" data-id="${t.id}">Supprimer</button>${t.completed===0?`<button class="btn-complete" data-id="${t.id}">Terminer</button>`:""}</div></div><div class="task-content">${t.description}</div>`,c.querySelector(".btn-delete").onclick=()=>{a.exec(`DELETE FROM tasks WHERE id=${t.id}`),r()};const i=c.querySelector(".btn-complete");i&&(i.onclick=()=>{a.exec(`UPDATE tasks SET completed=1 WHERE id=${t.id}`),r()}),e.appendChild(c)})}document.getElementById("logout").onclick=()=>{d=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none"}}globalThis.unlockDB=h;
