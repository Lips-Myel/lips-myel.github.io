(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function n(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(e){if(e.ep)return;e.ep=!0;const r=n(e);fetch(e.href,r)}})();let o,m,i,E;const u="demo2026",S=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function y(a){const s=new TextEncoder,n=await crypto.subtle.importKey("raw",s.encode(a),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:S,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function b(a,s){const n=await y(s),t=a.slice(0,12),e=a.slice(12);return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:t},n,e))}async function I(a,s){const n=await y(s),t=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},n,a),r=new Uint8Array(t.length+e.byteLength);return r.set(t),r.set(new Uint8Array(e),12),r}async function h(){if(document.getElementById("master-pass").value.trim()!==u)return alert("Master Password incorrect â†’ dÃ©mo : demo2026");const s=await initSqlJs({locateFile:n=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${n}`});try{const n=await fetch("db.encrypted",{cache:"no-store"});if(n.ok){const t=await n.arrayBuffer(),e=await b(new Uint8Array(t),u);o=new s.Database(e)}else o=new s.Database}catch{o=new s.Database}m=u,f(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",E=new Quill("#task-editor",{theme:"snow"}),R()}function f(){o.exec(`
    CREATE TABLE IF NOT EXISTS users(id INTEGER PRIMARY KEY,username TEXT UNIQUE,password TEXT,salt TEXT);
    CREATE TABLE IF NOT EXISTS tasks(id INTEGER PRIMARY KEY,user_id INTEGER,title TEXT,description TEXT,completed INTEGER DEFAULT 0,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(user_id)REFERENCES users(id));
  `);try{o.exec("ALTER TABLE users ADD COLUMN salt TEXT")}catch{}}async function T(){if(!o||!m)return;const a=o.export(),s=await I(a,m),n=new Blob([s]),t=URL.createObjectURL(n),e=document.createElement("a");e.href=t,e.download="db.encrypted",e.click(),URL.revokeObjectURL(t),Swal.fire({toast:!0,icon:"success",title:"âœ… db.encrypted sauvegardÃ© !",timer:3e3})}async function p(a,s){const n=new TextEncoder,t=await crypto.subtle.importKey("raw",n.encode(a),"PBKDF2",!1,["deriveBits"]),e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:s,iterations:1e5,hash:"SHA-256"},t,256);return Array.from(new Uint8Array(e)).map(r=>r.toString(16).padStart(2,"0")).join("")}async function g(){o.exec("DELETE FROM users"),o.exec("DELETE FROM tasks"),f();const a=crypto.getRandomValues(new Uint8Array(16)),s=await p("demo123",a),n=Array.from(a).map(t=>t.toString(16).padStart(2,"0")).join("");o.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run("demo",s,n),i=o.prepare("SELECT id FROM users WHERE username=?").get("demo").id,d(),T()}setInterval(()=>{confirm("ðŸ”„ Reset auto de la dÃ©mo (30 min) ?")&&g()},1800*1e3);function d(){if(!i||!o)return;const a=o.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC"),s=a.all(i);a.free();const n=document.getElementById("tasks-list");n.innerHTML="",s.forEach(t=>{const e=document.createElement("li");e.className=t.completed?"completed":"",e.innerHTML=`<div class="task-header"><h3>${t.title}</h3><div class="btn-container"><button class="btn-delete" data-id="${t.id}">Supprimer</button>${t.completed===0?`<button class="btn-complete" data-id="${t.id}">Terminer</button>`:""}</div></div><div class="task-content">${t.description}</div>`,e.querySelector(".btn-delete").onclick=()=>{o.exec(`DELETE FROM tasks WHERE id=${t.id}`),d()};const r=e.querySelector(".btn-complete");r&&(r.onclick=()=>{o.exec(`UPDATE tasks SET completed=1 WHERE id=${t.id}`),d()}),n.appendChild(e)})}function R(){const a=document.querySelector(".header-tasks"),s=document.createElement("button");s.className="btn",s.style.background="#007bff",s.style.marginLeft="10px",s.innerHTML="ðŸ“¥ Sauvegarder db.encrypted",s.onclick=T,a.appendChild(s),document.getElementById("register-form").addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("register-username").value.trim(),e=document.getElementById("register-password").value,r=crypto.getRandomValues(new Uint8Array(16)),c=await p(e,r),l=Array.from(r).map(w=>w.toString(16).padStart(2,"0")).join("");try{o.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run(t,c,l),Swal.fire({toast:!0,icon:"success",title:"Compte crÃ©Ã©"}),n.target.reset()}catch{Swal.fire({toast:!0,icon:"error",title:"Username dÃ©jÃ  pris"})}}),document.getElementById("login-form").addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("login-username").value.trim(),e=document.getElementById("login-password").value,r=o.prepare("SELECT id,password,salt FROM users WHERE username=?").get(t);if(r){if(!r.salt){g();return}const c=new Uint8Array(r.salt.match(/.{1,2}/g).map(l=>parseInt(l,16)));if(await p(e,c)===r.password){i=r.id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",d();return}}Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects"})}),document.getElementById("add-task-form").addEventListener("submit",n=>{if(n.preventDefault(),!i)return;const t=document.getElementById("task-title").value.trim(),e=E.root.innerHTML;o.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run(i,t,e),document.getElementById("task-title").value="",E.setContents([]),d()}),document.getElementById("logout").onclick=()=>{i=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none"}}globalThis.unlockDB=h;
