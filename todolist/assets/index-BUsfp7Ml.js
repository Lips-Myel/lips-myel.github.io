(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();let o,m,c,u,y=null;const f="demo2026",g="secure.db",w=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function T(e){const n=new TextEncoder,t=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:w,iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function I(e){const n=crypto.getRandomValues(new Uint8Array(12)),t=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},m,e),s=new Uint8Array(n.length+t.byteLength);return s.set(n),s.set(new Uint8Array(t),12),s}async function h(e){if(!e||e.length<12)return null;const n=e.slice(0,12),t=e.slice(12),s=await crypto.subtle.decrypt({name:"AES-GCM",iv:n},m,t);return new Uint8Array(s)}async function E(){return(await navigator.storage.getDirectory()).getFileHandle(g,{create:!0})}async function A(){try{const n=await(await E()).createWritable(),t=await I(o.export());await n.write(t),await n.close()}catch(e){console.error("Save error:",e)}}async function b(e){try{const t=await(await E()).getFile();if(t.size===0)return new e.Database;const s=new Uint8Array(await t.arrayBuffer()),r=await h(s);return r?new e.Database(r):new e.Database}catch{return new e.Database}}function l(){clearTimeout(y),y=setTimeout(A,400)}async function B(){const e=document.getElementById("master-pass").value.trim();if(e!==f)return alert("Mot de passe incorrect (demo2026)");m=await T(e);const n=await initSqlJs({locateFile:t=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${t}`});o=await b(n),S(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",u=new Quill("#task-editor",{theme:"snow"}),v()}function S(){o.exec(`
    CREATE TABLE IF NOT EXISTS users(
      id INTEGER PRIMARY KEY,
      username TEXT UNIQUE,
      password TEXT,
      salt TEXT
    );

    CREATE TABLE IF NOT EXISTS tasks(
      id INTEGER PRIMARY KEY,
      user_id INTEGER,
      title TEXT,
      description TEXT,
      completed INTEGER DEFAULT 0
    );
  `)}async function p(e,n){const t=new TextEncoder,s=await crypto.subtle.importKey("raw",t.encode(e),"PBKDF2",!1,["deriveBits"]),r=await crypto.subtle.deriveBits({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},s,256);return Array.from(new Uint8Array(r)).map(a=>a.toString(16).padStart(2,"0")).join("")}function d(){const e=document.getElementById("tasks-list");e.innerHTML="";const n=o.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY id DESC");for(n.bind([c]);n.step();){const t=n.getAsObject(),s=document.createElement("li");s.innerHTML=`
      <strong>${t.title}</strong>
      <div>${t.description}</div>
      <button data-id="${t.id}" class="complete">‚úÖ</button>
      <button data-id="${t.id}" class="delete">üóëÔ∏è</button>
    `,e.appendChild(s)}n.free(),e.querySelectorAll(".delete").forEach(t=>{t.onclick=()=>{o.prepare("DELETE FROM tasks WHERE id=?").run([t.dataset.id]),l(),d()}}),e.querySelectorAll(".complete").forEach(t=>{t.onclick=()=>{o.prepare("UPDATE tasks SET completed=1 WHERE id=?").run([t.dataset.id]),l(),d()}})}function v(){document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();const n=document.getElementById("register-username").value.trim(),t=document.getElementById("register-password").value,s=crypto.getRandomValues(new Uint8Array(16)),r=await p(t,s),a=Array.from(s).map(i=>i.toString(16).padStart(2,"0")).join("");try{o.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run([n,r,a]),l(),alert("Compte cr√©√© ‚úÖ")}catch{alert("Username d√©j√† pris")}}),document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const n=document.getElementById("login-username").value.trim(),t=document.getElementById("login-password").value,s=o.prepare("SELECT * FROM users WHERE username=?").get([n]);if(!s)return alert("Identifiants incorrects");const r=new Uint8Array(s.salt.match(/.{1,2}/g).map(i=>Number.parseInt(i,16)));if(await p(t,r)!==s.password)return alert("Identifiants incorrects");c=s.id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",d()}),document.getElementById("add-task-form").addEventListener("submit",e=>{if(e.preventDefault(),!c)return;const n=document.getElementById("task-title").value.trim(),t=u.root.innerHTML;n&&(o.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run([c,n,t]),l(),d(),document.getElementById("task-title").value="",u.setText(""))}),document.getElementById("logout").onclick=()=>{c=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none"}}globalThis.unlockDB=B;
