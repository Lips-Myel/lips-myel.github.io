(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const o of e)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function s(e){const o={};return e.integrity&&(o.integrity=e.integrity),e.referrerPolicy&&(o.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?o.credentials="include":e.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(e){if(e.ep)return;e.ep=!0;const o=s(e);fetch(e.href,o)}})();let i,d,l,u;const p=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function E(a){const n=new TextEncoder,s=await crypto.subtle.importKey("raw",n.encode(a),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:p,iterations:1e5,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function f(a,n){const s=await E(n),t=a.slice(0,12),e=a.slice(12);return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:t},s,e))}async function T(a,n){const s=await E(n),t=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},s,a),o=new Uint8Array(t.length+e.byteLength);return o.set(t),o.set(new Uint8Array(e),12),o}async function w(){const a=document.getElementById("master-pass").value.trim();if(!a)return alert("Master Password requis");const n=await initSqlJs({locateFile:s=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${s}`});try{if(fetch("db.encrypted"),r.ok){const s=await r.arrayBuffer(),t=await f(new Uint8Array(s),a);i=new n.Database(t)}else i=new n.Database}catch{i=new n.Database}d=a,g(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",u=new Quill("#task-editor",{theme:"snow"}),L(),Swal.fire({toast:!0,icon:"success",title:"Base déverrouillée",timer:1500})}function g(){i.exec("CREATE TABLE IF NOT EXISTS users(id INTEGER PRIMARY KEY,username TEXT UNIQUE NOT NULL,password TEXT NOT NULL,salt TEXT);CREATE TABLE IF NOT EXISTS tasks(id INTEGER PRIMARY KEY,user_id INTEGER NOT NULL,title TEXT NOT NULL,description TEXT,completed INTEGER DEFAULT 0,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(user_id)REFERENCES users(id));");try{i.exec("ALTER TABLE users ADD COLUMN salt TEXT")}catch{}}async function I(){if(!i||!d)return;const a=i.export(),n=await T(a,d),s=new Blob([n]),t=URL.createObjectURL(s),e=document.createElement("a");e.href=t,e.download="db.encrypted",e.click(),URL.revokeObjectURL(t)}async function m(a,n){const s=new TextEncoder,t=await crypto.subtle.importKey("raw",s.encode(a),"PBKDF2",!1,["deriveBits"]),e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},t,256);return Array.from(new Uint8Array(e)).map(o=>o.toString(16).padStart(2,"0")).join("")}function L(){document.getElementById("register-form").addEventListener("submit",async n=>{n.preventDefault();const s=document.getElementById("register-username").value.trim(),t=document.getElementById("register-password").value,e=crypto.getRandomValues(new Uint8Array(16)),o=await m(t,e),c=Array.from(e).map(y=>y.toString(16).padStart(2,"0")).join("");try{i.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run(s,o,c),Swal.fire({toast:!0,icon:"success",title:"Compte sécurisé créé",timer:2e3}),n.target.reset()}catch{Swal.fire({toast:!0,icon:"error",title:"Username déjà pris"})}}),document.getElementById("login-form").addEventListener("submit",async n=>{n.preventDefault();const s=document.getElementById("login-username").value.trim(),t=document.getElementById("login-password").value,e=i.prepare("SELECT id,password,salt FROM users WHERE username=?").get(s);if(e){if(!e.salt){Swal.fire({toast:!0,icon:"error",title:"Compte ancien → recrée-le"});return}const o=new Uint8Array(e.salt.match(/.{1,2}/g).map(c=>parseInt(c,16)));if(await m(t,o)===e.password){l=e.id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",a();return}}Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects"})}),document.getElementById("add-task-form").addEventListener("submit",n=>{if(n.preventDefault(),!l)return;const s=document.getElementById("task-title").value.trim(),t=u.root.innerHTML;i.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run(l,s,t),document.getElementById("task-title").value="",u.setContents([]),a()});function a(){const n=i.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC").all(l),s=document.getElementById("tasks-list");s.innerHTML="",n.forEach(t=>{const e=document.createElement("li");e.className=t.completed?"completed":"",e.innerHTML=`<div class="task-header"><h3>${t.title}</h3><div class="btn-container"><button class="btn-delete" data-id="${t.id}">Supprimer</button>${t.completed===0?`<button class="btn-complete" data-id="${t.id}">Terminer</button>`:""}</div></div><div class="task-content">${t.description}</div>`,e.querySelector(".btn-delete").onclick=()=>{i.exec(`DELETE FROM tasks WHERE id=${t.id}`),a()};const o=e.querySelector(".btn-complete");o&&(o.onclick=()=>{i.exec(`UPDATE tasks SET completed=1 WHERE id=${t.id}`),a()}),s.appendChild(e)})}document.getElementById("download-db").onclick=I,document.getElementById("logout").onclick=()=>{l=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none",document.getElementById("tasks-list").innerHTML=""}}globalThis.unlockDB=w;
