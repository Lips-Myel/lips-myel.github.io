(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const o of t.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function r(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(e){if(e.ep)return;e.ep=!0;const t=r(e);fetch(e.href,t)}})();let c,m,d,p;const u="demo2026",S=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function y(a){const n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(a),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:S,iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function b(a,n){const r=await y(n),s=a.slice(0,12),e=a.slice(12);return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:s},r,e))}async function h(a,n){const r=await y(n),s=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},r,a),t=new Uint8Array(s.length+e.byteLength);return t.set(s),t.set(new Uint8Array(e),12),t}async function I(){if(document.getElementById("master-pass").value.trim()!==u)return alert("Master Password incorrect â†’ dÃ©mo : demo2026");const n=await initSqlJs({locateFile:r=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${r}`});try{const r=await fetch("db.encrypted",{cache:"no-store"});if(r.ok){const s=await r.arrayBuffer(),e=await b(new Uint8Array(s),u);c=new n.Database(e)}else c=new n.Database}catch{c=new n.Database}m=u,f(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",p=new Quill("#task-editor",{theme:"snow"}),R()}function f(){c.exec(`
    CREATE TABLE IF NOT EXISTS users(id INTEGER PRIMARY KEY,username TEXT UNIQUE,password TEXT,salt TEXT);
    CREATE TABLE IF NOT EXISTS tasks(id INTEGER PRIMARY KEY,user_id INTEGER,title TEXT,description TEXT,completed INTEGER DEFAULT 0,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(user_id)REFERENCES users(id));
  `);try{c.exec("ALTER TABLE users ADD COLUMN salt TEXT")}catch{}}async function T(){if(!c||!m)return;const a=c.export(),n=await h(a,m),r=new Blob([n]),s=URL.createObjectURL(r),e=document.createElement("a");e.href=s,e.download="db.encrypted",e.click(),URL.revokeObjectURL(s),Swal.fire({toast:!0,icon:"success",title:"âœ… db.encrypted sauvegardÃ© !",timer:3e3})}async function E(a,n){const r=new TextEncoder,s=await crypto.subtle.importKey("raw",r.encode(a),"PBKDF2",!1,["deriveBits"]),e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},s,256);return Array.from(new Uint8Array(e)).map(t=>t.toString(16).padStart(2,"0")).join("")}async function w(){c.exec("DELETE FROM users"),c.exec("DELETE FROM tasks"),f();const a=crypto.getRandomValues(new Uint8Array(16)),n=await E("demo123",a),r=Array.from(a).map(s=>s.toString(16).padStart(2,"0")).join("");c.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run("demo",n,r),d=c.prepare("SELECT id FROM users WHERE username=?").get("demo").id,loadTasks(),T(),Swal.fire({toast:!0,icon:"success",title:"Reset complet effectuÃ©",timer:4e3})}setInterval(()=>{confirm(`ðŸ”„ Reset auto de la dÃ©mo (toutes les 30 minutes) ?
TOUS les comptes ET toutes les tÃ¢ches seront supprimÃ©s.`)&&w()},1800*1e3);function R(){const a=document.querySelector(".header-tasks"),n=document.createElement("button");n.className="btn",n.style.background="#007bff",n.style.marginLeft="10px",n.innerHTML="ðŸ“¥ Sauvegarder db.encrypted",n.onclick=T,a.appendChild(n),document.getElementById("register-form").addEventListener("submit",async s=>{s.preventDefault();const e=document.getElementById("register-username").value.trim(),t=document.getElementById("register-password").value,o=crypto.getRandomValues(new Uint8Array(16)),i=await E(t,o),l=Array.from(o).map(g=>g.toString(16).padStart(2,"0")).join("");try{c.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run(e,i,l),Swal.fire({toast:!0,icon:"success",title:"Compte crÃ©Ã©"}),s.target.reset()}catch{Swal.fire({toast:!0,icon:"error",title:"Username dÃ©jÃ  pris"})}}),document.getElementById("login-form").addEventListener("submit",async s=>{s.preventDefault();const e=document.getElementById("login-username").value.trim(),t=document.getElementById("login-password").value,o=c.prepare("SELECT id,password,salt FROM users WHERE username=?").get(e);if(o){if(!o.salt){Swal.fire({toast:!0,icon:"info",title:"Base ancienne dÃ©tectÃ©e â†’ reset auto"}),w();return}const i=new Uint8Array(o.salt.match(/.{1,2}/g).map(l=>parseInt(l,16)));if(await E(t,i)===o.password){d=o.id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",r();return}}Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects"})}),document.getElementById("add-task-form").addEventListener("submit",s=>{if(s.preventDefault(),!d)return;const e=document.getElementById("task-title").value.trim(),t=p.root.innerHTML;c.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run(d,e,t),document.getElementById("task-title").value="",p.setContents([]),r()});function r(){const s=c.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC").all(d),e=document.getElementById("tasks-list");e.innerHTML="",s.forEach(t=>{const o=document.createElement("li");o.className=t.completed?"completed":"",o.innerHTML=`<div class="task-header"><h3>${t.title}</h3><div class="btn-container"><button class="btn-delete" data-id="${t.id}">Supprimer</button>${t.completed===0?`<button class="btn-complete" data-id="${t.id}">Terminer</button>`:""}</div></div><div class="task-content">${t.description}</div>`,o.querySelector(".btn-delete").onclick=()=>{c.exec(`DELETE FROM tasks WHERE id=${t.id}`),r()};const i=o.querySelector(".btn-complete");i&&(i.onclick=()=>{c.exec(`UPDATE tasks SET completed=1 WHERE id=${t.id}`),r()}),e.appendChild(o)})}document.getElementById("logout").onclick=()=>{d=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none"}}globalThis.unlockDB=I;
