(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(e){if(e.ep)return;e.ep=!0;const r=t(e);fetch(e.href,r)}})();let a,p,c,E;const m="demo2026",h=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function f(o){const s=new TextEncoder,t=await crypto.subtle.importKey("raw",s.encode(o),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:h,iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function S(o,s){const t=await f(s),n=o.slice(0,12),e=o.slice(12);return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:n},t,e))}async function A(o,s){const t=await f(s),n=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,o),r=new Uint8Array(n.length+e.byteLength);return r.set(n),r.set(new Uint8Array(e),12),r}async function I(){if(document.getElementById("master-pass").value.trim()!==m)return alert("Master Password incorrect â†’ dÃ©mo : demo2026");const s=await initSqlJs({locateFile:t=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${t}`});try{const t=await fetch("db.encrypted",{cache:"no-store"});if(t.ok){const n=await t.arrayBuffer(),e=await S(new Uint8Array(n),m);a=new s.Database(e)}else a=new s.Database}catch{a=new s.Database}p=m,T(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",E=new Quill("#task-editor",{theme:"snow"}),R()}function T(){a.exec(`
    CREATE TABLE IF NOT EXISTS users(
      id INTEGER PRIMARY KEY,
      username TEXT UNIQUE,
      password TEXT,
      salt TEXT
    );
    CREATE TABLE IF NOT EXISTS tasks(
      id INTEGER PRIMARY KEY,
      user_id INTEGER,
      title TEXT,
      description TEXT,
      completed INTEGER DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY(user_id) REFERENCES users(id)
    );
  `);try{a.exec("ALTER TABLE users ADD COLUMN salt TEXT")}catch{}}async function w(){if(!a||!p)return;const o=a.export(),s=await A(o,p),t=new Blob([s]),n=URL.createObjectURL(t),e=document.createElement("a");e.href=n,e.download="db.encrypted",e.click(),URL.revokeObjectURL(n),Swal.fire({toast:!0,icon:"success",title:"âœ… Sauvegarde effectuÃ©e",timer:2e3,showConfirmButton:!1})}async function d(){await w(),b()}async function y(o,s){const t=new TextEncoder,n=await crypto.subtle.importKey("raw",t.encode(o),"PBKDF2",!1,["deriveBits"]),e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:s,iterations:1e5,hash:"SHA-256"},n,256);return Array.from(new Uint8Array(e)).map(r=>r.toString(16).padStart(2,"0")).join("")}async function g(){a.exec("DELETE FROM users"),a.exec("DELETE FROM tasks"),T();const o=crypto.getRandomValues(new Uint8Array(16)),s=await y("demo123",o),t=Array.from(o).map(e=>e.toString(16).padStart(2,"0")).join("");a.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run(["demo",s,t]);const n=a.prepare("SELECT id FROM users WHERE username=?");n.bind(["demo"]),n.step(),c=n.getAsObject().id,n.free(),d(),Swal.fire({toast:!0,icon:"success",title:"Reset complet effectuÃ©",timer:4e3,showConfirmButton:!1})}setInterval(()=>{confirm("ðŸ”„ Reset auto de la dÃ©mo (30 min) ?")&&g()},1800*1e3);function b(){if(!c||!a)return;const o=document.getElementById("tasks-list");o.innerHTML="";const s=a.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC");for(s.bind([c]);s.step();){const t=s.getAsObject(),n=document.createElement("li");n.className=t.completed?"completed":"",n.innerHTML=`
      <div class="task-header">
        <h3>${t.title}</h3>
        <div class="btn-container">
          <button class="btn-delete" data-id="${t.id}">Supprimer</button>
          ${t.completed===0?`<button class="btn-complete" data-id="${t.id}">Terminer</button>`:""}
        </div>
      </div>
      <div class="task-content">${t.description}</div>
    `,n.querySelector(".btn-delete").onclick=()=>{a.prepare("DELETE FROM tasks WHERE id=?").run([t.id]),d()};const e=n.querySelector(".btn-complete");e&&(e.onclick=()=>{a.prepare("UPDATE tasks SET completed=1 WHERE id=?").run([t.id]),d()}),o.appendChild(n)}s.free()}function R(){const o=document.querySelector(".header-tasks"),s=document.createElement("button");s.className="btn",s.style.cssText="background:#007bff;margin-left:10px;",s.innerHTML="ðŸ“¥ Sauvegarder db.encrypted",s.onclick=w,o.appendChild(s),document.getElementById("register-form").addEventListener("submit",async t=>{t.preventDefault();const n=document.getElementById("register-username").value.trim(),e=document.getElementById("register-password").value,r=crypto.getRandomValues(new Uint8Array(16)),i=await y(e,r),l=Array.from(r).map(u=>u.toString(16).padStart(2,"0")).join("");try{a.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run([n,i,l]),Swal.fire({toast:!0,icon:"success",title:"Compte crÃ©Ã© âœ…",timer:2e3,showConfirmButton:!1}),t.target.reset()}catch{Swal.fire({toast:!0,icon:"error",title:"Username dÃ©jÃ  pris",timer:2e3,showConfirmButton:!1})}}),document.getElementById("login-form").addEventListener("submit",async t=>{t.preventDefault();const n=document.getElementById("login-username").value.trim(),e=document.getElementById("login-password").value,r=a.prepare("SELECT id,password,salt FROM users WHERE username=?");if(r.bind([n]),!r.step())return r.free(),Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects",timer:2e3,showConfirmButton:!1});const i=r.getAsObject();if(r.free(),!i.salt){g();return}const l=new Uint8Array(i.salt.match(/.{1,2}/g).map(u=>Number.parseInt(u,16)));if(await y(e,l)!==i.password)return Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects",timer:2e3,showConfirmButton:!1});c=i.id,document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",b()}),document.getElementById("add-task-form").addEventListener("submit",t=>{if(t.preventDefault(),!c)return;const n=document.getElementById("task-title").value.trim(),e=E.root.innerHTML;n&&(a.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run([c,n,e]),document.getElementById("task-title").value="",E.setText(""),d())}),document.getElementById("logout").onclick=()=>{c=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none"}}globalThis.unlockDB=I;
