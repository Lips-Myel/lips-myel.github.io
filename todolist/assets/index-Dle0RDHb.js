(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function n(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerPolicy&&(s.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?s.credentials="include":e.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(e){if(e.ep)return;e.ep=!0;const s=n(e);fetch(e.href,s)}})();let a,m,c,p;const u="demo2026",S=new Uint8Array([42,133,77,211,99,22,188,45,67,201,55,88,199,12,33,66]);async function y(o){const r=new TextEncoder,n=await crypto.subtle.importKey("raw",r.encode(o),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:S,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function b(o,r){const n=await y(r),t=o.slice(0,12),e=o.slice(12);return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:t},n,e))}async function I(o,r){const n=await y(r),t=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},n,o),s=new Uint8Array(t.length+e.byteLength);return s.set(t),s.set(new Uint8Array(e),12),s}async function h(){if(document.getElementById("master-pass").value.trim()!==u)return alert("Master Password incorrect â†’ dÃ©mo : demo2026");const r=await initSqlJs({locateFile:n=>`https://cdn.jsdelivr.net/npm/sql.js@1.14.0/dist/${n}`});try{const n=await fetch("db.encrypted",{cache:"no-store"});if(n.ok){const t=await n.arrayBuffer(),e=await b(new Uint8Array(t),u);a=new r.Database(e)}else a=new r.Database}catch{a=new r.Database}m=u,f(),document.getElementById("master-modal").style.display="none",document.getElementById("app").style.display="block",p=new Quill("#task-editor",{theme:"snow"}),R()}function f(){a.exec(`
    CREATE TABLE IF NOT EXISTS users(id INTEGER PRIMARY KEY,username TEXT UNIQUE,password TEXT,salt TEXT);
    CREATE TABLE IF NOT EXISTS tasks(id INTEGER PRIMARY KEY,user_id INTEGER,title TEXT,description TEXT,completed INTEGER DEFAULT 0,created_at DATETIME DEFAULT CURRENT_TIMESTAMP,FOREIGN KEY(user_id)REFERENCES users(id));
  `);try{a.exec("ALTER TABLE users ADD COLUMN salt TEXT")}catch{}}async function T(){if(!a||!m)return;const o=a.export(),r=await I(o,m),n=new Blob([r]),t=URL.createObjectURL(n),e=document.createElement("a");e.href=t,e.download="db.encrypted",e.click(),URL.revokeObjectURL(t),Swal.fire({toast:!0,icon:"success",title:"âœ… db.encrypted sauvegardÃ© !",timer:3e3})}async function E(o,r){const n=new TextEncoder,t=await crypto.subtle.importKey("raw",n.encode(o),"PBKDF2",!1,["deriveBits"]),e=await crypto.subtle.deriveBits({name:"PBKDF2",salt:r,iterations:1e5,hash:"SHA-256"},t,256);return Array.from(new Uint8Array(e)).map(s=>s.toString(16).padStart(2,"0")).join("")}async function g(){a.exec("DELETE FROM users"),a.exec("DELETE FROM tasks"),f();const o=crypto.getRandomValues(new Uint8Array(16)),r=await E("demo123",o),n=Array.from(o).map(t=>t.toString(16).padStart(2,"0")).join("");a.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run("demo",r,n),c=a.prepare("SELECT id FROM users WHERE username=?").get("demo").id,d(),T(),Swal.fire({toast:!0,icon:"success",title:"Reset complet effectuÃ©",timer:4e3})}setInterval(()=>{confirm(`ðŸ”„ Reset auto de la dÃ©mo (toutes les 30 minutes) ?
TOUS les comptes ET toutes les tÃ¢ches seront supprimÃ©s.`)&&g()},1800*1e3);function d(){if(!c||!a)return;const o=a.prepare("SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC"),r=o.all(c);o.free();const n=document.getElementById("tasks-list");n.innerHTML="",r.forEach(t=>{const e=document.createElement("li");e.className=t.completed?"completed":"",e.innerHTML=`<div class="task-header"><h3>${t.title}</h3><div class="btn-container"><button class="btn-delete" data-id="${t.id}">Supprimer</button>${t.completed===0?`<button class="btn-complete" data-id="${t.id}">Terminer</button>`:""}</div></div><div class="task-content">${t.description}</div>`,e.querySelector(".btn-delete").onclick=()=>{a.exec(`DELETE FROM tasks WHERE id=${t.id}`),d()};const s=e.querySelector(".btn-complete");s&&(s.onclick=()=>{a.exec(`UPDATE tasks SET completed=1 WHERE id=${t.id}`),d()}),n.appendChild(e)})}function R(){const o=document.querySelector(".header-tasks"),r=document.createElement("button");r.className="btn",r.style.background="#007bff",r.style.marginLeft="10px",r.innerHTML="ðŸ“¥ Sauvegarder db.encrypted",r.onclick=T,o.appendChild(r),document.getElementById("register-form").addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("register-username").value.trim(),e=document.getElementById("register-password").value,s=crypto.getRandomValues(new Uint8Array(16)),i=await E(e,s),l=Array.from(s).map(w=>w.toString(16).padStart(2,"0")).join("");try{a.prepare("INSERT INTO users(username,password,salt)VALUES(?,?,?)").run(t,i,l),Swal.fire({toast:!0,icon:"success",title:"Compte crÃ©Ã©"}),n.target.reset()}catch{Swal.fire({toast:!0,icon:"error",title:"Username dÃ©jÃ  pris"})}}),document.getElementById("login-form").addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("login-username").value.trim(),e=document.getElementById("login-password").value,s=a.prepare("SELECT id,password,salt FROM users WHERE username=?").get(t);if(s){if(!s.salt){Swal.fire({toast:!0,icon:"info",title:"Base ancienne â†’ reset auto"}),g();return}const i=new Uint8Array(s.salt.match(/.{1,2}/g).map(l=>parseInt(l,16)));if(await E(e,i)===s.password){c=s.id,console.log("âœ… Login rÃ©ussi - userId:",c),document.getElementById("auth-section").style.display="none",document.getElementById("tasks-section").style.display="block",d();return}}Swal.fire({toast:!0,icon:"error",title:"Identifiants incorrects"})}),document.getElementById("add-task-form").addEventListener("submit",n=>{if(n.preventDefault(),!c)return alert("Connecte-toi dâ€™abord");const t=document.getElementById("task-title").value.trim(),e=p.root.innerHTML;a.prepare("INSERT INTO tasks(user_id,title,description)VALUES(?,?,?)").run(c,t,e),document.getElementById("task-title").value="",p.setContents([]),d()}),document.getElementById("logout").onclick=()=>{c=null,document.getElementById("auth-section").style.display="block",document.getElementById("tasks-section").style.display="none"}}globalThis.unlockDB=h;
